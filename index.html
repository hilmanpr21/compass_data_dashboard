<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8"> 
    <title></title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css' rel='stylesheet'/>
    
    <!--Adding Geocoder script-->
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1-dev/mapbox-gl-geocoder.min.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1-dev/mapbox-gl-geocoder.css'  rel='stylesheet'/>    
    
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&display=swap" rel="stylesheet">
    <link href='style.css' rel='stylesheet' />
</head>



<body>
    
    <div id="navbar" class="navbar">
        <div class="nav-content">
            <h1>SPEEDING BEHAVIOUR</h1>
        </div>
        <div class="nav-content">
            <a class="active" data-target="maps" href="#map">Map</a>
            <a class="nav-link" data-target="methods" href="#methods">Methods</a>
            <a class="nav-link" data-target="references" href="#references">References</a>
            <a class="nav-link" data-target="acknowledgements" href="#acknowledgements">Acknowledgements</a>
        </div>
    </div>

    <div id="map"></div>
    
    <div class="map-overlay" id="widget">
        <div class="map-overlay-content">
            <h1>
                SPEEDING BEHAVIOUR
            </h1>
            <h2>
                England, United Kingdom
            </h2>

            <div id="region-dropdown" class="region-dropdown">
                <select id="region" class="region-select">
                    <option value="" disabled selected>Select Regions...</option>
                    <option value="-0.12,51.5">London</option>
                    <option value="-1.62,53.8">West Yorkshire</option>
                    <option value="0.13,52.19">Cambridge</option>
                    <option value="-3.16,51.48">Cardiff</option>
                    <option value="-3.18,55.95">Edinburgh</option>
                    <option value="-4.25,55.86">Glasgow</option>
                    <option value="-2.99,53.4">Liverpool</option>
                    <option value="-2.24,53.48">Manchester</option>
                    <option value="-1.62,54.97">Newcastle</option>
                    <option value="-1.25,51.75">Oxford</option>
                    <option value="-1.33,53.4">South Yorkshire</option>
                    <option value="-3.99,50.77">West England</option>
                    <option value="-1.82,52.47">West Midland</option>
                </select>
                <span class="region-arrow"></span>
            </div>

            <div id="slider">
                <h2>Adherence rate  &le; <label id="speed-limit">100</label>%</h2>
                <input type="range" id="speed-limit-slider" name="speed-slider" min="20" max="100" value="100" step="10" />
                <div class="slider-number">
                    <p>20</p>
                    <p>30</p>
                    <p>40</p>
                    <p>50</p>
                    <p>60</p>
                    <p>70</p>
                    <p>80</p>
                    <p>90</p>
                    <p>100</p>
                </div>
            </div>
            
    
            <div id="info" class="info">
                <div id="info-data">
                    <div class="info-row">
                        <h3>Link ADH Rate: </h3><p></p>
                    </div>
                    <div class="info-row">
                        <h3>Average speed: </h3><p></p>
                    </div>
                    <div class="info-row">
                        <h3>Point Count: </h3><p></p>
                    </div>
                    <div class="info-row">
                        <h3>Average Width: </h3><p></p>
                    </div>
                    <div class="info-row">
                        <h3>Link Speeding Account: </h3><p></p>
                    </div>
                </div>
            </div> 
        </div>
    </div>

    <!--Add muted layer when the popup content appear-->
    <div id="muted-overlay" class="muted-overlay"></div>

    <!--Pop up content for Methods-->
    <div id="popup-methods" class="popup-content">
        <div class="popup-header">
            <button class="close-btn">&times;</button>
            <h2>METHODS</h2>
        </div>
        <div class="popup-columns">
            <div class="popup-column-content">
                <p>1. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            </div>
            <div class="popup-column-content">
                <p>2. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            </div>
            <div class="popup-column-content">
                <p>3. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            </div>
            <div class="popup-column-content">
                <p>4. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            </div>
        </div>
    </div>

    <!--Pop up content for references-->
    <div id="popup-references" class="popup-content">
        <button class="close-btn">&times;</button>
        <h2>REFERENCES</h2>
        <div class="popup-columns">
            <div class="popup-column-content">
                <p>1. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            </div>
            <div class="popup-column-content">
                <p>2. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            </div>
            <div class="popup-column-content">
                <p>3. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            </div>
            <div class="popup-column-content">
                <p>4. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            </div>
        </div>
    </div>

    <!--Pop up content for Acknowledgement-->
    <div id="popup-acknowledgements" class="popup-content">
        <button class="close-btn">&times;</button>
        <h2>ACKNOWLEDGEMENT</h2>
        <div class="popup-columns">
            <div class="popup-column-content">
                <p>1. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            </div>
            <div class="popup-column-content">
                <p>2. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            </div>
            <div class="popup-column-content">
                <p>3. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            </div>
            <div class="popup-column-content">
                <p>4. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="logo">
            <img class="logo" src="../../04_image/CDRC_logo.png" alt="CDRC-logo">
        </div>
    </div>

    

    <script>

        

        mapboxgl.accessToken = 'pk.eyJ1IjoiaGlsbWFucHIyMSIsImEiOiJjbGQxbGhycTAwZG01M3BxcWV5ejB2ZGtzIn0.wnQW51k0xp5SEd1ggujsiA';

        const map = new mapboxgl.Map({
            container: 'map', // container ID
            style: 'mapbox://styles/hilmanpr21/cm1pfpqqa00re01qrhaqz05fw', // style URL
            center:  [-1.62, 53.8], // starting position [lng, lat]
            zoom: 11, // starting zoom
            minzoom: 9
        });

        // Variable to store the ID of the currently hovered feature
        let hoveredFeatureId = null;

        map.on('load', () => {
            map.addSource('westyorkshire',{
                type: 'vector',
                url: 'mapbox://hilmanpr21.8d0rl1bk',
                promoteId: 'TOID' // add this to promote TOID as unique identifier
            });



            map.addLayer({
                id: 'westyorkshire_speed_limit',
                type: 'line',
                source: 'westyorkshire',
                'source-layer': 'westyorkshire-9lff31',
                paint: {
                    'line-color': ['interpolate', ['linear'],
                        ['get', 'link_adhrate'],
                        20, '#c51b7d',
                        30, '#de77ae',
                        40, '#f1b6da',
                        50, '#fde0ef',
                        60, '#e6f5d0',
                        70, '#b8e186',
                        80, '#7fbc41',
                        90, '#4d9221',
                        100, '#276419'
                    ], 
                    'line-opacity': 1, 
                    'line-width': [
                        'case', 
                        ['boolean', ['feature-state', 'hover'], false], 
                        6, //for linewidth when the data is hovered
                        2  //for linewidth on normal condition or hover is false
                    ]
                }
            });
        });

        // Set Cursor style on the map
        map.getCanvas().style.cursor = 'default';

        // HOVER
        // Add hover effect
        map.on('mousemove', 'westyorkshire_speed_limit', (e) => {
            //get the feature ID
            const featureId = e.features[0].properties.TOID;

            // if hovered features changes, update feature state
            if (hoveredFeatureId !== null && hoveredFeatureId !== featureId) {
                map.setFeatureState(
                    { source: 'westyorkshire', sourceLayer: 'westyorkshire-9lff31', id: hoveredFeatureId},
                    {hover: false}
                );
            }

            hoveredFeatureId = featureId;

            map.setFeatureState(
                { source: 'westyorkshire', sourceLayer: 'westyorkshire-9lff31', id: hoveredFeatureId},
                {hover: true}
            );
        });

        // Remove hover effect when leaving the layer
        map.on('mouseleave', 'westyorkshire_speed_limit', () => {
            if (hoveredFeatureId !== null) {
                map.setFeatureState(
                    { source: 'westyorkshire', sourceLayer: 'westyorkshire-9lff31', id: hoveredFeatureId },
                    { hover: false }
                );
            }
            hoveredFeatureId = null;
        });

        // change info in hovering
        map.on('mousemove', (event) => {

            map.getCanvas().style.cursor = 'pointer';
            
            // save the data into a 
            const speedData = map.queryRenderedFeatures(event.point,
                {
                    layers: ['westyorkshire_speed_limit']                
                }
            );
            document.getElementById('info-data').innerHTML=
            speedData.length
            ?`<div class="info-row">
                        <h3>Link ADH Rate: </h3><p>${speedData[0].properties.link_adhrate}</p>
                    </div>
                    <div class="info-row">
                        <h3>Average speed: </h3><p>${speedData[0].properties.avg_speed}</p>
                    </div>
                    <div class="info-row">
                        <h3>Point Count: </h3><p>${speedData[0].properties.ptcount}</p>
                    </div>
                    <div class="info-row">
                        <h3>Average Width: </h3><p>${speedData[0].properties.averagewidth}</p>
                    </div>
                    <div class="info-row">
                        <h3>Link Speeding Account: </h3><p>${speedData[0].properties.link_speedingcount}</p>
            </div>
            ` //Set the content on how the div want to be overwrite when hover
            : 
            //when normal or not hovered
            `<div class="info-row">
                        <h3>Link ADH Rate: </h3><p></p>
                    </div>
                    <div class="info-row">
                        <h3>Average speed: </h3><p></p>
                    </div>
                    <div class="info-row">
                        <h3>Point Count: </h3><p></p>
                    </div>
                    <div class="info-row">
                        <h3>Average Width: </h3><p></p>
                    </div>
                    <div class="info-row">
                        <h3>Link Speeding Account: </h3><p></p>
                    </div>`;
        });

        // Adherence Slider
        // Add event listener for adherence slider
        document.getElementById('speed-limit-slider').addEventListener('input', (event) => {
            const speed = parseInt(event.target.value);
            // To filter the map value '<=' meaning less or equals
            // 'westyorkshire_speed_limit' is the map layer
            // 'link_adhrate'is the column in the tileset that represent ADH (adharance) rate
            map.setFilter('westyorkshire_speed_limit', ['<=', ['get', 'link_adhrate'], speed]);
        
            // to print the value we are have in the slider
            // meaning change the label that has 'speed-limit' ID with value stored under 'speed' const
            document.getElementById('speed-limit').innerText = speed;
        });

        // SEARCHBOX GEOCODING
        // Add geocoding script
        const geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl, //link geocoder to the map instance
            placeholder: 'Search for location...', //placeholder text for the search box
            countries: 'gb',
        });
        // Add geocoding position by default inside the map
        map.addControl(geocoder, 'top-right') //add the geocoder to the top righ of the map
        // Add geocoding Search Result, (this one is optional as mapbox already have a default but nice to have to set the zoom setting)
        geocoder.on('result', (event) => {
            console.log('Selected location:', event.result);
            map.flyTo({
                center: event.result.center,
                zoom: 15
            });
        });

        // USER'S LOCATION
        // Add location detection for users
        const geolocate = new mapboxgl.GeolocateControl({
            trackUserLocation: true, //will activateupdate to the device locations
            showAccuracyCircle: false, //if true will show buffer circle to indicate location accuracy
        });
        // positioning geolocation
        map.addControl(geolocate, 'top-right');


        // FLY TO REGION
        // get the dropdown element
        const dropdown = document.getElementById('region-dropdown');
        // listen for dropdown changes
        dropdown.addEventListener('change', (event) => {
            const selectedRegion = event.target.value;
            if (selectedRegion) {
                const[lon, lat] = selectedRegion.split(',').map(Number) //to split and convert the numbers
                map.flyTo({
                    center: [lon, lat],
                    zoom: 12,
                    speed: 1.0,
                    curve: 1 //for smoothness of animation
                });
            }
        });

        // OPEN NAVIGATION POP UP
        // Make constant elements for interactivity
        const navLinks = document.querySelectorAll('.nav-link'); //selecting the navigation options in '.nav-link' class
        const overlay = document.getElementById('muted-overlay'); //select element with id 'muted-overlay' 
        const popups = document.querySelectorAll('.popup-content'); //selecting the class popup-content
        const closeButtons = document.querySelectorAll('.close-btn');
        const mapLink = document.querySelector('a[href="#map"]'); //select the "map" navlink

        //Function to show a pop-up
        function showPopup(target) {
            const popup = document.getElementById(`popup-${target}`);
            if (popup) {
                popup.style.display = 'block';
                overlay.style.display = 'block';
            }
        }

        //Function to hide all pop-ups
        function hidePopups() {
            popups.forEach(popup => popup.style.display = 'none');
            overlay.style.display = 'none';

            //reset active class for all nav link (nav bar) and activate "map"
            document.querySelectorAll('.nav-content a').forEach(navLink => navLink.classList.remove('active'));
            
        }

        //attach click listener to nav links
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const target = e.target.getAttribute('data-target');

                
                hidePopups(); //close any open popups

                if (target) {
                    showPopup(target); //to show the target popup
                    link.classList.add('active'); //Set the clicked link as active
                }


                // add 'active' to the clisked links
                link.classList.add('active');

            });
        });

        // Close button on navigation popup
        closeButtons.forEach(button => {
            button.addEventListener('click', () => {
                hidePopups(); //close popups
                mapLink.classList.add('active');

            });
        });

        // close popups when clicking outdise popups
        overlay.addEventListener('click',   () => {
            hidePopups();
            mapLink.classList.add('active');
        });

        // Add click event to "Map" link to close all popups
        mapLink.addEventListener('click', (e) => {
            e.preventDefault();
            hidePopups();
            mapLink.classList.add('active');
        })

    </script>

</body>

</html>